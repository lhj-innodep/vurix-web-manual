<script>
(function () {
  const viewer = document.getElementById('viewer');
  const links  = Array.from(document.querySelectorAll('.menu-row a'));
  const routeMap = {
    '#start':  'start.html',
    '#live':   'live.html',
    '#record': 'record.html',
    '#event':  'event.html',
    '#setup':  'setup.html',
    '#other':  'other.html',
    '#info':   'info.html'
  };

  // 후보 경로 자동 탐지 (루트/ko/docs 어디에 두든 작동)
  const candidates = ['pages/', 'ko/pages/', '../ko/pages/', '../../ko/pages/', 'docs/ko/pages/'];
  let pagesBase = null;

  async function resolveBase(file) {
    for (const base of candidates) {
      try {
        const url = new URL(base + file, location.href);
        const res = await fetch(url.toString(), { method: 'HEAD', cache: 'no-store' });
        if (res.ok) return base;
      } catch (e) {}
    }
    return 'ko/pages/'; // 폴백
  }

  function setActive(hash) {
    links.forEach(a => a.removeAttribute('aria-current'));
    const t = links.find(a => a.getAttribute('href') === hash);
    if (t) t.setAttribute('aria-current', 'page');
  }

  async function loadFromHash() {
    const hash = location.hash || '#start';
    const file = routeMap[hash] || 'start.html';
    if (!pagesBase) pagesBase = await resolveBase(file);
    viewer.src = pagesBase + file;
    setActive(routeMap[hash] ? hash : '#start');
  }

  // --- 아이콘 경로 보정 ---
  function projectBasePath() {
    // GitHub Pages: /<username>.github.io/<repo>/... 형태
    // location.pathname에서 repo 이름까지를 잘라냅니다.
    const parts = location.pathname.split('/').filter(Boolean);
    // 예) ['', 'vurix-web-manual', '...'] → '/vurix-web-manual/'
    const repoIndex = parts.indexOf('vurix-web-manual');
    if (repoIndex >= 0) return '/' + parts[repoIndex] + '/';
    // 로컬 파일이나 다른 호스팅일 때는 현재 경로 기준
    return '/';
  }

  function fixIconPaths(doc) {
    const base = projectBasePath();
    const iconAbs = base + 'ko/assets/icon/'; // 아이콘의 "정답 경로"
    const imgs = Array.from(doc.querySelectorAll('img[src*=\"0_ICON\" i], img[src*=\"icon\" i]'));
    for (const img of imgs) {
      try {
        const name = img.getAttribute('src').split(/[\\/]/).pop(); // 파일명만 추출
        if (!name) continue;
        img.setAttribute('src', iconAbs + name);
      } catch (e) {}
    }
  }

  // iframe 내부 스크롤 제거 + 높이 자동 조절
  function resizeToContent() {
    try {
      const doc = viewer.contentDocument || viewer.contentWindow.document;
      if (!doc) return;

      // 내부 스크롤 원천 차단
      const style = doc.createElement('style');
      style.textContent = 'html,body{overflow:hidden !important;margin:0 !important;}';
      doc.head && doc.head.appendChild(style);

      // 아이콘 경로 보정 실행
      fixIconPaths(doc);

      // 높이 계산
      const body = doc.body, html = doc.documentElement;
      const h = Math.max(
        body.scrollHeight, body.offsetHeight,
        html.clientHeight, html.scrollHeight, html.offsetHeight
      );
      viewer.style.height = h + 'px';
    } catch (e) {}
  }

  // 메뉴 네비게이션
  links.forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      const hash = a.getAttribute('href');
      if (location.hash !== hash) history.pushState(null, '', hash);
      loadFromHash();
    });
  });
  window.addEventListener('popstate', loadFromHash);
  window.addEventListener('hashchange', loadFromHash);

  // 컨텐츠 로드/변경 감지 → 리사이즈 & 아이콘 재보정
  viewer.addEventListener('load', () => {
    resizeToContent();
    try {
      const doc = viewer.contentDocument;
      const observer = new MutationObserver(() => resizeToContent());
      observer.observe(doc.documentElement, { childList: true, subtree: true, attributes: true, characterData: true });
      Array.from(doc.images || []).forEach(img => {
        if (!img.complete) img.addEventListener('load', resizeToContent);
      });
    } catch (e) {}
  });

  // 최초 로드
  loadFromHash();
})();
</script>
